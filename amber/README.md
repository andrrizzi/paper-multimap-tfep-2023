## Manifest

- ``amber_3ob.in``: AMBER input script with a 0-step dynamics used by ASE to evaluate the DFTB3/3ob energies.
- ``amber_mm.in``: AMBER input script with a 0-step dynamics used by ASE to evaluate the MM energies.
- ``test_amber.py``: The script performing the test.

These files/directories are generated by ``test_amber.py``:

- ``offsets_3ob.json``: The SCCDFTB potential energy between CHARMM and AMBER differs by a constant offset. This file
                        stores this offset for each molecule (see also below for more info).
- ``offsets_mm.json``: The MM potential energy between CHARMM and AMBER differs by a constant offset. This file
                       stores this offset for each molecule (see also below for more info).
- ``prmtop/``: The AMBER topology files converted by ParmEd from ``psf`` to ``prmtop`` format.
- ``energy_amber/``: Contain the potential energies computed with AMBER at the MM or DFTB3 level of theory for each
                     molecule in ``.npy`` format.
- ``tmp/``: Temporary working directory used to run AMBER. This is not deleted for debugging purposes in case of errors.


## Requirements

The ``test_amber.py`` script requires ParmEd to convert ``psf`` files into ``prmtop`` and MDAnalysis and ASE (and
AMBER) to evaluate AMBER energies. Here is a way to install the dependencies (except for AMBER) using conda+pip.
```
conda create --name ase python=3.8
conda activate ase
conda install -c conda-forge mdanalysis parmed
pip install --upgrade --user ase
```

# Usage

Before using this test, it is necessary to run ``../hipen/dyna_mm.slurm`` with ``rand1=1`` for all molecules.
Then simply run
```
python test_amber.py
```
The script will select 100 samples from those trajectories, recompute their energies at the MM or DFTB3 level using
AMBER and compare them with those that were computed with CHARMM. An error is raised if
``numpy.allclose(charmm_energies, amber_energies)`` is false.

The script also output an ``offset_3ob/mm.json`` file. Since the zero of the AMBER and CHARMM DFTB3 potentials is
different, this file includes the offset for each molecule in kcal/mol in ``dict`` format such that
``amber_energy + offset = charmm_energy``.
